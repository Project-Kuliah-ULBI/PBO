<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta SiJabar</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* 1. RESET DAN LAYOUT */
        body,
        html,
        #map {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* 2. HAPUS KOTAK DEFAULT MARKER LEAFLET */
        .leaflet-div-icon {
            background: transparent;
            border: none;
        }

        /* 3. STYLING POPUP INFO */
        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 8px;
            padding: 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .custom-popup .leaflet-popup-tip {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .leaflet-popup-content h4 {
            margin: 0 0 6px 0;
            color: #333;
            font-size: 15px;
            font-weight: 700;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .leaflet-popup-content p {
            margin: 0;
            font-size: 13px;
            color: #555;
        }

        /* 4. STYLING MARKER CUSTOM (PIN MODERN) */
        .modern-pin svg {
            /* Bayangan lembut agar marker terlihat melayang */
            filter: drop-shadow(0px 3px 2px rgba(0, 0, 0, 0.3));
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            /* Efek membal */
            transform-origin: bottom center;
        }

        /* Efek Hover: Marker membesar sedikit */
        .modern-pin:hover svg {
            transform: scale(1.15) translateY(-5px);
            filter: drop-shadow(0px 8px 5px rgba(0, 0, 0, 0.3));
            cursor: pointer;
        }

        /* 5. STYLING LEGENDA (KOTAK KETERANGAN) */
        .legend {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            line-height: 1.6;
            color: #555;
            min-width: 150px;
        }

        .legend h4 {
            margin: 0 0 8px;
            font-size: 14px;
            color: #333;
            font-weight: bold;
        }

        .legend div {
            display: flex;
            align-items: center;
        }

        .legend span {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 8px;
            border-radius: 50%;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        var map = null;
        var markers = [];
        var inputMarker = null;
        var isInputMode = false; // Default: DISABLED (View only). Forms call setInputMode(true)

        // --- PALET WARNA MODERN (SOFT PASTEL) ---
        const palette = {
            blue: '#3498db', // Biru Laut (Master)
            red: '#e74c3c', // Merah Soft (Masuk)
            green: '#2ecc71', // Hijau Soft (Selesai)
            yellow: '#f1c40f', // Kuning Emas (Proses)
            gray: '#95a5a6',  // Default
            admin: '#2c3e50',   // Midnight Blue
            petugas: '#d35400', // Dark Orange
            masyarakat: '#8e44ad' // Amethyst Purple
        };

        // 1. INISIALISASI PETA
        function initMap(lat, lon, zoom) {
            try {
                if (map) return;

                map = L.map('map', {
                    zoomControl: false
                }).setView([lat, lon], zoom);

                L.control.zoom({ position: 'bottomright' }).addTo(map);

                // TILE LAYER: OPENSTREETMAP
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // EVENT KLIK (HANYA JIKA MODE INPUT AKTIF)
                map.on('click', function (e) {
                    if (!isInputMode) return;

                    updateInputMarker(e.latlng.lat, e.latlng.lng);

                    if (window.chrome && window.chrome.webview) {
                        var data = {
                            type: 'click', // Flag manual click
                            lat: e.latlng.lat,
                            lng: e.latlng.lng
                        };
                        window.chrome.webview.postMessage(JSON.stringify(data));
                    }
                });
            } catch (err) {
                console.error('initMap error:', err);
            }
        }

        // 2. DETEKSI LOKASI OTOMATIS (GPS)
        function locateUser() {
            if (!navigator.geolocation) {
                alert("Geolocation tidak didukung oleh browser Anda.");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function (position) {
                    var lat = position.coords.latitude;
                    var lon = position.coords.longitude;

                    // Update Map & Marker
                    if (map) {
                        map.setView([lat, lon], 16);
                        updateInputMarker(lat, lon);
                    }

                    // Send to C#
                    if (window.chrome && window.chrome.webview) {
                        var data = {
                            type: 'gps', // Flag message type
                            lat: lat,
                            lng: lon
                        };
                        window.chrome.webview.postMessage(JSON.stringify(data));
                    }
                },
                function (error) {
                    var msg = "Gagal mendapatkan lokasi: ";
                    switch (error.code) {
                        case error.PERMISSION_DENIED: msg += "Izin ditolak."; break;
                        case error.POSITION_UNAVAILABLE: msg += "Lokasi tidak tersedia."; break;
                        case error.TIMEOUT: msg += "Waktu permintaan habis."; break;
                        default: msg += "Terjadi kesalahan tidak dikenal."; break;
                    }
                    alert(msg);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        // 3. SAKLAR MODE INPUT
        function setInputMode(enable) {
            isInputMode = enable;
        }

        // 3. FUNGSI UNTUK FORM INPUT
        function setLocation(lat, lon) {
            if (!map) return;
            map.setView([lat, lon], 16);
            updateInputMarker(lat, lon);
        }

        function updateInputMarker(lat, lon) {
            try {
                if (inputMarker) map.removeLayer(inputMarker);

                inputMarker = L.marker([lat, lon], {
                    icon: createModernIcon(palette.red),
                    zIndexOffset: 2000
                }).addTo(map);

                inputMarker.bindPopup("<b>Lokasi Terpilih</b>").openPopup();
            } catch (err) {
                console.error('updateInputMarker error:', err);
            }
        }

        function removeInputMarker() {
            try {
                if (inputMarker) {
                    map.removeLayer(inputMarker);
                    inputMarker = null;
                }
            } catch (err) {
                console.error('removeInputMarker error:', err);
            }
        }

        // 4. FUNGSI UNTUK DASHBOARD (FORM MAP)
        function addMarker(lat, lon, title, desc, colorCodeFromCSharp, zIndex) {
            try {
                if (!map) {
                    console.error('addMarker: map is null!');
                    return 'ERROR_MAP_NULL';
                }

                // Safeguard defaults (use explicit undefined/null checks, NOT falsy checks)
                if (title === undefined || title === null) title = "Lokasi";
                if (desc === undefined || desc === null) desc = "";
                if (colorCodeFromCSharp === undefined || colorCodeFromCSharp === null) colorCodeFromCSharp = "blue";
                if (zIndex === undefined || zIndex === null) zIndex = 0;

                // Logika Mapping Warna
                var finalColor = palette.gray;
                var c = String(colorCodeFromCSharp).toLowerCase();

                if (c.includes('007bff') || c.includes('blue') || c.includes('3498db')) finalColor = palette.blue;
                else if (c.includes('e74c3c') || c.includes('red') || c.includes('ff0000')) finalColor = palette.red;
                else if (c.includes('28a745') || c.includes('green') || c.includes('2ecc71')) finalColor = palette.green;
                else if (c.includes('ffc107') || c.includes('yellow') || c.includes('gold') || c.includes('f1c40f')) finalColor = palette.yellow;
                else if (c == 'admin' || c.includes('#2c3e50')) finalColor = palette.admin;
                else if (c == 'petugas' || c.includes('#d35400')) finalColor = palette.petugas;
                else if (c == 'masyarakat' || c.includes('#8e44ad')) finalColor = palette.masyarakat;
                else finalColor = colorCodeFromCSharp;

                var myIcon = createModernIcon(finalColor);

                var marker = L.marker([lat, lon], {
                    icon: myIcon,
                    zIndexOffset: zIndex
                }).addTo(map);

                var popupContent = '<h4>' + title + '</h4><p>' + desc + '</p>';
                marker.bindPopup(popupContent, { className: 'custom-popup' });

                markers.push(marker);
                return 'OK';
            } catch (err) {
                console.error('addMarker error:', err);
                return 'ERROR: ' + err.message;
            }
        }

        function clearMarkers() {
            try {
                if (map) {
                    markers.forEach(function (m) { map.removeLayer(m); });
                }
                markers = [];
                return 'OK';
            } catch (err) {
                console.error('clearMarkers error:', err);
                markers = [];
                return 'ERROR: ' + err.message;
            }
        }

        // 5. GENERATOR ICON SVG MODERN (BENTUK TEARDROP)
        function createModernIcon(color) {
            var svgString = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 43.62" width="36" height="49">' +
                '<path d="M16,0C7.16,0,0,7.16,0,16c0,9.76,13.69,25.63,14.88,27a1.74,1.74,0,0,0,2.24,0C18.31,41.63,32,25.76,32,16,32,7.16,24.84,0,16,0Zm0,24a8,8,0,1,1,8-8A8,8,0,0,1,16,24Z" fill="' + color + '"/>' +
                '<circle cx="16" cy="16" r="6" fill="white" fill-opacity="0.95"/>' +
                '</svg>';

            return L.divIcon({
                className: "modern-pin",
                html: svgString,
                iconSize: [36, 49],
                iconAnchor: [18, 49],
                popupAnchor: [0, -45]
            });
        }

        // 6. Utility: Get marker count (for debugging from C#)
        function getMarkerCount() {
            return markers.length;
        }

        // 7. Utility: Check if map is ready
        function isMapReady() {
            return map !== null && map !== undefined;
        }
    </script>
</body>

</html>